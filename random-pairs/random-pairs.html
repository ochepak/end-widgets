<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
              content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Random pair | EN Widgets</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <link href="./random-pairs.css" rel="stylesheet">
    </head>

    <body>
        <div class="container-fluid p-2">
            <div id="pairs-container">
                <h1>Press «Start» to begin</h1>
            </div>
            <button id="start-btn" type="button" class="mt-3 btn btn-primary">Start</button>
        </div>

        <script type="text/javascript">
            const startBtn = document.querySelector("#start-btn");
            const values = {};
            let started = false;
            let partsNumber = 2;

            window.addEventListener("message", (ev) => {
                const urlSearchParams = new URLSearchParams(ev.data);
                for (let key of urlSearchParams.keys()) {
                    values[key] = key.includes('Color') ? urlSearchParams.get(key) : urlSearchParams.get(key).split(",");
                }

                console.log(values);
                partsNumber = Object.keys(values).length / 2;
                document.querySelector(".container-fluid").style.visibility = "visible";
            });

            startBtn.addEventListener("click", ({ target }) => {
                next();
            });

            function getRandomElementFromArray(array) {
                return array[Math.floor(Math.random() * array.length)];
            }

            function next() {
                let randomPair = "";

                for (let i = 1; i <= partsNumber; i++) {
                    const colorKey = `p${ i }Color`;
                    const value = getRandomElementFromArray(values[`p${ i }`]);

                    randomPair += `<span class="pair ${ i % 2 === 0 ? 'even' : 'odd' }" style="color: ${ values[colorKey] }">${ value }</span>`;
                }

                if (!started) {
                    startBtn.innerText = "Next";
                    document.querySelector("#pairs-container").innerHTML = randomPair;
                } else {
                    document.querySelectorAll("#pairs-container .pair").forEach((el) => {
                        el.classList.add('is-removing');
                        startBtn.disabled = true;
                    });
                    setTimeout(() => {
                        document.querySelector("#pairs-container").innerHTML = randomPair;
                        startBtn.disabled = false;
                    }, 400);
                }

                started = true;
            }
        </script>
    </body>
</html>
